{% load static %}

<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Probador Wang</title>
        <link href="{% static 'bootstrap.min.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'favicon.png' %}" rel="shortcut icon">
    </head>
    <body>
        <header id="header">
            <img style="width: 100%; height:100px;" src="{% static 'Logo2.png' %}" alt=""/>
        </header>
        <div class="container">
            <br>
            <h1>Bienvenido, Probador LÃ³gico Wang</h1>
            <hr class="mb-4">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <form action="javascript:enviarPruebaLogica();">
						<label for="idExpresion">Digite la expresion:</label>
                        <div class="row">
                            <div class="col-md-9 mb-3">
                                <input type="text" class="form-control" id="idExpresion" maxlength="50" autocomplete="off" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <input type="submit" class="btn btn-success" value="Enviar">
                            </div>

                        </div>
                    </form>
                </div>
                <div class="col-md-6 mb-3">
					<div class="row">
						<div class="col-md-1 mb-3">
							<div style="border-left: 6px solid green;height: 500px;"></div>
						</div>
						<div class="col-md-11 mb-3">
							<h5 class="text-center">Arbol de prueba</h5>
							<div class="text-center" id="divRespuesta">
							
							</div>
						</div>
					</div>
                </div>
            </div>
        </div>
        <footer id="footer"></footer>

        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="{% static 'viz.js' %}"></script>
        <script src="{% static 'full.render.js' %}"></script>
        <script>
            var axiomNumber = 1;
            var errorNumber = 1;
            function enviarPruebaLogica() {
                prueba = document.getElementById("idExpresion").value;
                axios.post('http://localhost:8000/requestAPI/', {
                    "expresion": prueba
                })
                        .then(function (response) {
                            datos = response.data.respuesta

                            datosJSON = JSON.parse(datos)

                            deduccion = datosJSON.deduction
                            array = deduccion.split(" => ")

                            izq = array[0].split(", ")

                            der = "".split(", ")
							
							divR = document.getElementById("divRespuesta");
							showTree(datosJSON, divR);
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
            }
            function showTree(data, div){
                let viz = new Viz();
                viz.renderSVGElement('digraph T { node [shape=rectangle,color=black];' + buildStringTree(data) + '}')
                    .then(function (element) {
                            div.innerHTML = "";
                            div.appendChild(element);
                        })
                        .catch(error => {
                            viz = new Viz();
                            console.error(error);
                        });         
                axiomNumber = errorNumber = 1; 
            }
            function buildStringTree(data) {
                let ded = data.deduction.split(" => ");
                let left = ded[0].split(", ");
                let right = ded[1].split(", ");
                let string = '';
                if(data.RuleType === "AXIOM"){
                    let axiomNode = '"' + axiomNumber + '. AXIOM: ' + left[data.posLeft] + '"[shape=tripleoctagon, color=green];';
                    return axiomNode + '"' + data.deduction + '"->"' + axiomNumber++ +'. AXIOM: ' + left[data.posLeft] + '";';  
                }
                else if(data.children.length === 0){
                    let notProvenNode = '"' + errorNumber + '. NOT PROVEN: ' + data.deduction + '"[shape=octagon, color=red];';
                    return notProvenNode + '"' + data.deduction + '"->"' + errorNumber++ +'. NOT PROVEN: ' + data.deduction + '";'; 
                } else {
                    for(let child of data.children){
                        if(data.RuleType === "EQUIV" || data.RuleType === "BICONDITIONAL"){
                            let changes = (data.posLeft !== -1 ? left[data.posLeft] : right[data.posRight]);
                            string += '"' + data.deduction + '"->"' + child.deduction + '"[label="   ' + data.RuleType + ': ' + changes + '"];';
                            string += buildStringTree(child);
                        } else {
                            let changes = (isLeft(data.RuleType)? left[data.pos] : right[data.pos]);  
                            string += '"' + data.deduction + '"->"' + child.deduction + '"[label="   ' + data.RuleType + ': ' + changes + '"];';
                            string += buildStringTree(child);
                        }
                    }
                }
                return string;  
            }
            function isLeft(rule) {
                return (rule === "OR LEFT" || rule === "AND LEFT" || rule === "NOT LEFT");
            }
        </script>
    </body>
</html>

